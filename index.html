<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Toko Sederhana</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Styling tambahan untuk hasil analisa agar lebih rapi di WhatsApp (opsional, untuk tampilan di web) */
    .whatsapp-pre {
        white-space: pre-wrap; /* Mempertahankan spasi dan baris baru */
        font-family: monospace; /* Font monospasi agar format lebih konsisten */
    }
  </style>
</head>
<body>
  <header>
    <h1>PENGECEKAN KESEHATAN LAMBUNGMU</h1>
    <p>GERD, ASLAM, DISPEPSIA.</p>
  </header>

  <section class="age-check">
    <h2>Usia Anda</h2>
    <form id="ageForm">
      <label for="age">Umur Anda:</label>
      <input type="number" id="age" name="age" min="1" max="120" required />
    </form>
    <p id="ageMessage"></p>
  </section>

  <section class="symptoms">
    <h2>Pilih Gejala yang Anda Alami</h2>
    <form id="symptomForm">
      <div class="checkbox-columns">
        <div class="left-column">
          <label><input type="checkbox" name="gejala" value="Perut kembung" /> Perut kembung</label><br />
          <label><input type="checkbox" name="gejala" value="Dada terasa panas (heartburn)" /> Dada terasa panas (heartburn)</label><br />
          <label><input type="checkbox" name="gejala" value="Asam naik ke tenggorokan" /> Asam naik ke tenggorongan</label><br />
          <label><input type="checkbox" name="gejala" value="Mual/muntah" /> Mual/muntah</label><br />
          <label><input type="checkbox" name="gejala" value="Sering sendawa" /> Sering sendawa</label><br />
          <label><input type="checkbox" name="gejala" value="Tenggorokan Gatal atau Batuk Kering" /> Tenggorokan Gatal atau Batuk Kering</label><br />
        </div>
        <div class="right-column">
          <label><input type="checkbox" name="gejala" value="Sesak Nafas Terutama Malam" /> Sesak Nafas Terutama Malam</label><br />
          <label><input type="checkbox" name="gejala" value="Pusing atau Kepala Ringan" /> Pusing atau Kepala Ringan</label><br />
          <label><input type="checkbox" name="gejala" value="Merasa ingin Pingsan" /> Merasa ingin Pingsan</label><br />
          <label><input type="checkbox" name="gejala" value="Dada tertekan seperti Serangan Jantung" /> Dada tertekan seperti Serangan Jantung</label><br />
          <label><input type="checkbox" name="gejala" value="Nafas Pendek/Berat saat Cemas" /> Nafas Pendek/Berat saat Cemas</label><br />
        </div>
      </div>
    </form>
    <p id="symptomResult"></p>
  </section>

  <section class="mental-checklist hidden-section" id="mentalSection">
    <h2>Gejala psikologi yang Anda Rasakan</h2>
    <form id="mentalForm">
      <div class="checkbox-columns" id="mentalCheckboxesContainer">
        </div>
    </form>
  </section>

  <section class="habit-checklist hidden-section" id="habitSection">
    <h2>Kebiasaan Sehari-hari</h2>
    <form id="habitForm">
      <div class="checkbox-columns" id="habitCheckboxesContainer">
        </div>
    </form>
  </section>

  <section class="impact-checklist hidden-section" id="impactSection">
    <h2>Dampak yang Anda Alami</h2>
    <form id="impactForm">
      <div class="checkbox-columns" id="impactCheckboxesContainer">
        </div>
    </form>
  </section>

  <section class="duration-select hidden-section" id="durationSection">
    <h2>Berapa Lama Gejala Dialami?</h2>
    <form id="durationForm">
      <select id="duration" name="duration" required>
        <option value="" disabled selected>Pilih Durasi</option>
        <option value="<<1 minggu"> << 1 minggu</option>
        <option value="1-3 minggu">1-4 minggu</option>
        <option value="1-3 bulan">1-3 bulan</option>
        <option value=">> 3 bulan">>> 3 bulan</option>
        <option value="1 tahun">1 tahun</option>
        <option value="2 tahun">2 tahun</option>
        <option value="3 tahun">3 tahun</option>
        <option value="Lebih dari 3 tahun">Lebih dari 3 tahun</option>
      </select>
    </form>
    <p id="durationResult"></p>
  </section>

  <div class="tombol-container">
    <button id="cekButton">Cek Hasil</button>
  </div>

  <div id="hasilPenilaian" class="hasil-container" style="display: none;"></div>

  <section class="menu">
    <h2>Katalog Produk Tiens</h2>
    <div class="carousel-container">
      <button class="carousel-button left" onclick="scrollCarousel('left')">&#10094;</button>
      <div class="product-catalog" id="tiensProductCatalog">
        </div>
      <button class="carousel-button right" onclick="scrollCarousel('right')">&#10095;</button>
    </div>
  </section>

  <footer>
    <p>üìç Alamat Toko | üìû 0857-2136-8380 | üìß email@tokomu.com</p>
    <p>&copy; 2025 Toko Sederhana</p>
  </footer>

  <script>
    // Data lengkap produk Tiens
    const tiensProducts = [
      {
        id: "Nutrient Super Calcium Powder",
        name: "Nutrient Super Calcium Powder",
        image: "images/calcium.jpg", // PASTIKAN PATH INI BENAR
        description: "Suplemen kalsium tinggi untuk kesehatan tulang, gigi, dan mendukung fungsi tubuh. Dapat membantu menetralkan asam lambung.",
        whatsappText: "Halo saya mau pesan Nutrient Super Calcium Powder Tiens"
      },
      {
        id: "Zinc Capsules",
        name: "Zinc Capsules",
        image: "images/zinc.jpg", // PASTIKAN PATH INI BENAR
        description: "Meningkatkan daya tahan tubuh, membantu regenerasi sel, dan penting untuk penyembuhan luka termasuk di saluran pencernaan.",
        whatsappText: "Halo saya mau pesan Zinc Capsules Tiens"
      },
      {
        id: "Chitin Chitosan Capsules",
        name: "Chitin Chitosan Capsules",
        image: "images/chitosan.jpg", // PASTIKAN PATH INI BENAR
        description: "Serat alami yang membantu detoksifikasi, mengikat lemak, dan mendukung kesehatan pencernaan secara menyeluruh.",
        whatsappText: "Halo saya mau pesan Chitin Chitosan Capsules Tiens"
      }
    ];

    // Definisikan semua opsi checkbox untuk masing-masing kategori
    const allMentalSymptoms = [
      { value: "Pikiran berlebihan", label: "Pikiran berlebihan" },
      { value: "Sering gelisah tanpa alasan", label: "Sering gelisah tanpa alasan" },
      { value: "Sulit tidur", label: "Sulit tidur" },
      { value: "Sering merasa takut atau panik", label: "Sering merasa takut atau panik" },
      { value: "Bangun tidur dengan rasa cemas", label: "Bangun tidur dengan rasa cemas" },
      { value: "Takut makan karena takut kambuh", label: "Takut makan karena takut kambuh" },
      { value: "Ketergantungan pada obat-obatan", label: "Ketergantungan pada obat-obatan (antacid/obat lambung)" }
    ];

    const allHabits = [
      { value: "Makan tidak teratur", label: "Makan tidak teratur" },
      { value: "Sering makan pedas/berminyak", label: "Sering makan pedas/berminyak" },
      { value: "Sering minum kopi, soda, teh kental", label: "Sering minum kopi, soda, teh kental" },
      { value: "Suka rebahan langsung setelah makan", label: "Suka rebahan langsung setelah makan" },
      { value: "Sering begadang", label: "Sering begadang" },
      { value: "Jarang olahraga", label: "Jarang olahraga" },
      { value: "Merokok", label: "Merokok" },
      { value: "Sering konsumsi obat kimia", label: "Sering konsumsi obat kimia (NSAID, antibiotik, dll)" }
    ];

    const allImpacts = [
      { value: "Tidak nyaman saat ibadah/aktivitas sosial", label: "Tidak nyaman saat ibadah/aktivitas sosial" },
      { value: "Kehilangan nafsu makan", label: "Kehilangan nafsu makan" },
      { value: "Berat badan turun drastis", label: "Berat badan turun drastis" },
      { value: "Ketakutan berlebihan untuk kambuh", label: "Ketakutan berlebihan untuk kambuh" },
      { value: "Sudah konsultasi ke dokter tapi tetap kambuh", label: "Sudah konsultasi ke dokter tapi tetap kambuh" },
      { value: "Pernah dirawat karena asam lambung/GERD", label: "Pernah dirawat karena asam lambung/GERD" }
    ];

    // Variabel global untuk menyimpan teks hasil analisa
    let currentAnalysisResultText = "";

    // Variabel global untuk menyimpan daftar gejala yang dipilih dalam format teks
    let selectedSymptomsDetails = {
        fisik: "",
        mental: "",
        habit: "",
        impact: ""
    };

    // Fungsi untuk menampilkan katalog produk Tiens dalam carousel
    function displayTiensProducts(featuredProductId = null) {
      const catalogContainer = document.getElementById('tiensProductCatalog');
      if (!catalogContainer) {
          console.error("Elemen 'tiensProductCatalog' tidak ditemukan!");
          return;
      }
      catalogContainer.innerHTML = ''; // Bersihkan konten sebelumnya

      const sortedProducts = [...tiensProducts].sort((a, b) => {
        if (a.id === featuredProductId) return -1;
        if (b.id === featuredProductId) return 1;
        return 0;
      });

      sortedProducts.forEach(product => {
        const productDiv = document.createElement('div');
        productDiv.classList.add('product');
        if (product.id === featuredProductId) {
          productDiv.classList.add('featured');
        }

        // Gabungkan pesan produk dengan hasil analisa
        let whatsappMessage = `${product.whatsappText}\n\n`;
        if (currentAnalysisResultText) {
            whatsappMessage += "--- Hasil Analisa Kondisi Saya ---\n";
            whatsappMessage += currentAnalysisResultText;
            whatsappMessage += "\n----------------------------------";
        }


        productDiv.innerHTML = `
          <img src="${product.image}" alt="${product.name}" />
          <h3>${product.name}</h3>
          <p>${product.description}</p>
          <a href="https://wa.me/6285721368380?text=${encodeURIComponent(whatsappMessage)}" target="_blank">Pesan via WhatsApp</a>
        `;
        catalogContainer.appendChild(productDiv);
      });

      if (featuredProductId) {
        setTimeout(() => {
          const featuredElement = catalogContainer.querySelector('.product.featured');
          if (featuredElement) {
            catalogContainer.scrollLeft = featuredElement.offsetLeft - (carousel.offsetWidth / 2) + (featuredElement.offsetWidth / 2);
          }
        }, 100);
      }
    }

    // Fungsi untuk scroll carousel
    function scrollCarousel(direction) {
      const carousel = document.getElementById('tiensProductCatalog');
      if (!carousel) {
          console.error("Elemen 'tiensProductCatalog' tidak ditemukan untuk scroll!");
          return;
      }
      const scrollAmount = 300;

      if (direction === 'left') {
        carousel.scrollBy({
          left: -scrollAmount,
          behavior: 'smooth'
        });
      } else {
        carousel.scrollBy({
          left: scrollAmount,
          behavior: 'smooth'
        });
      }
    }

    // Fungsi untuk merender checkbox
    function renderCheckboxes(containerId, checkboxesData, nameAttribute, checkedValues = []) {
      const container = document.getElementById(containerId);
      if (!container) {
          console.error(`Elemen '${containerId}' tidak ditemukan untuk merender checkbox!`);
          return;
      }
      container.innerHTML = '';

      const leftColumn = document.createElement('div');
      leftColumn.classList.add('left-column');
      const rightColumn = document.createElement('div');
      rightColumn.classList.add('right-column');

      // Hitung jumlah item per kolom agar distribusi seimbang
      const itemsPerColumn = Math.ceil(checkboxesData.length / 2);

      checkboxesData.forEach((item, index) => {
        const label = document.createElement('label');
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.name = nameAttribute;
        input.value = item.value;
        if (checkedValues.includes(item.value)) {
            input.checked = true;
        }
        label.appendChild(input);
        label.appendChild(document.createTextNode(` ${item.label}`));

        // Distribusi item ke kolom kiri atau kanan
        if (index < itemsPerColumn) {
          leftColumn.appendChild(label);
        } else {
          rightColumn.appendChild(label);
        }
        // Tambahkan <br> untuk setiap label kecuali yang terakhir di kolomnya
        if (index < checkboxesData.length -1 && (index + 1) % itemsPerColumn !== 0) {
            leftColumn.appendChild(document.createElement('br'));
        }
        if (index >= itemsPerColumn && (index + 1) % itemsPerColumn !== 0 && index !== checkboxesData.length - 1) {
             rightColumn.appendChild(document.createElement('br'));
        }
      });

      container.appendChild(leftColumn);
      container.appendChild(rightColumn);
    }

    // --- Logika Progresif untuk Menampilkan Bagian Form ---

    const fisikCheckboxes = document.querySelectorAll('input[name="gejala"]');
    const mentalSection = document.getElementById('mentalSection');
    const habitSection = document.getElementById('habitSection');
    const impactSection = document.getElementById('impactSection');
    const durationSection = document.getElementById('durationSection');
    const ageInput = document.getElementById('age');
    const durationSelect = document.getElementById('duration');

    const symptomForm = document.getElementById('symptomForm');
    const mentalForm = document.getElementById('mentalForm');
    const habitForm = document.getElementById('habitForm');
    const impactForm = document.getElementById('impactForm');

    let selectedMentalValues = [];
    let selectedHabitValues = [];
    let selectedImpactValues = [];


    function checkFormProgress() {
      if (!mentalSection || !habitSection || !impactSection || !durationSection || !ageInput || !durationSelect) {
          console.error("Salah satu elemen section form tidak ditemukan. Pastikan ID HTML sudah benar.");
          return;
      }

      const selectedFisik = Array.from(fisikCheckboxes).some(cb => cb.checked);
      const currentMentalChecked = Array.from(document.querySelectorAll('#mentalForm input[name="mental"]:checked')).map(cb => cb.value);
      const currentHabitChecked = Array.from(document.querySelectorAll('#habitForm input[name="habit"]:checked')).map(cb => cb.value);
      const currentImpactChecked = Array.from(document.querySelectorAll('#impactForm input[name="impact"]:checked')).map(cb => cb.value);

      selectedMentalValues = currentMentalChecked;
      selectedHabitValues = currentHabitChecked;
      selectedImpactValues = currentImpactChecked;

      const hasSelectedMental = selectedMentalValues.length > 0;
      const hasSelectedHabit = selectedHabitValues.length > 0;
      const hasSelectedImpact = selectedImpactValues.length > 0;

      if (selectedFisik) {
        mentalSection.classList.remove('hidden-section');
        const checkedFisikValues = Array.from(fisikCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
        let relevantMentalSymptoms = [];
        const isAnxietyRelated = checkedFisikValues.some(symptom =>
          ["Sesak Nafas Terutama Malam", "Pusing atau Kepala Ringan", "Merasa ingin Pingsan", "Dada tertekan seperti Serangan Jantung", "Nafas Pendek/Berat saat Cemas"].includes(symptom)
        );
        const isGastricRelated = checkedFisikValues.some(symptom =>
          ["Perut kembung", "Dada terasa panas (heartburn)", "Asam naik ke tenggorokan", "Mual/muntah", "Sering sendawa", "Tenggorokan Gatal atau Batuk Kering"].includes(symptom)
        );

        // Aturan untuk menampilkan gejala mental yang relevan
        if (isAnxietyRelated && isGastricRelated) {
             relevantMentalSymptoms = allMentalSymptoms; // Tampilkan semua jika ada fisik ansietas dan lambung
        } else if (isAnxietyRelated) {
          relevantMentalSymptoms = allMentalSymptoms.filter(symptom =>
            ["Pikiran berlebihan", "Sering gelisah tanpa alasan", "Sulit tidur", "Sering merasa takut atau panik", "Bangun tidur dengan rasa cemas", "Takut makan karena takut kambuh"].includes(symptom.value)
          );
        } else if (isGastricRelated) {
          relevantMentalSymptoms = allMentalSymptoms.filter(symptom =>
            ["Pikiran berlebihan", "Sering gelisah tanpa alasan", "Sulit tidur", "Takut makan karena takut kambuh"].includes(symptom.value)
          );
        } else {
          relevantMentalSymptoms = allMentalSymptoms; // Default: tampilkan semua
        }
        renderCheckboxes('mentalCheckboxesContainer', relevantMentalSymptoms, 'mental', selectedMentalValues);

      } else {
        mentalSection.classList.add('hidden-section');
        selectedMentalValues = [];
        document.querySelectorAll('#mentalForm input[name="mental"]').forEach(cb => cb.checked = false);
      }

      if (selectedFisik && hasSelectedMental) {
        habitSection.classList.remove('hidden-section');
        renderCheckboxes('habitCheckboxesContainer', allHabits, 'habit', selectedHabitValues);
      } else {
        habitSection.classList.add('hidden-section');
        selectedHabitValues = [];
        document.querySelectorAll('#habitForm input[name="habit"]').forEach(cb => cb.checked = false);
      }

      if (selectedFisik && hasSelectedMental && hasSelectedHabit) {
        impactSection.classList.remove('hidden-section');
        renderCheckboxes('impactCheckboxesContainer', allImpacts, 'impact', selectedImpactValues);
      } else {
        impactSection.classList.add('hidden-section');
        selectedImpactValues = [];
        document.querySelectorAll('#impactForm input[name="impact"]').forEach(cb => cb.checked = false);
      }

      if (selectedFisik && hasSelectedMental && hasSelectedHabit && hasSelectedImpact) {
        durationSection.classList.remove('hidden-section');
      } else {
        durationSection.classList.add('hidden-section');
        durationSelect.value = "";
      }
    }

    ageInput.addEventListener('input', checkFormProgress);
    symptomForm.addEventListener('change', (event) => {
        if (event.target.type === 'checkbox' && event.target.name === 'gejala') {
            checkFormProgress();
        }
    });
    mentalForm.addEventListener('change', (event) => {
        if (event.target.type === 'checkbox' && event.target.name === 'mental') {
            checkFormProgress();
        }
    });
    habitForm.addEventListener('change', (event) => {
        if (event.target.type === 'checkbox' && event.target.name === 'habit') {
            checkFormProgress();
        }
    });
    impactForm.addEventListener('change', (event) => {
        if (event.target.type === 'checkbox' && event.target.name === 'impact') {
            checkFormProgress();
        }
    });
    durationSelect.addEventListener('change', checkFormProgress);


    // JavaScript logika Analisa Keparahan dan Rekomendasi
    function calculateSeverity() {
      const fisikCheckboxes = Array.from(document.querySelectorAll('input[name="gejala"]:checked'));
      const mentalCheckboxes = Array.from(document.querySelectorAll('#mentalForm input[name="mental"]:checked'));
      const habitCheckboxes = Array.from(document.querySelectorAll('#habitForm input[name="habit"]:checked'));
      const impactCheckboxes = Array.from(document.querySelectorAll('#impactForm input[name="impact"]:checked'));

      const durasiEl = document.getElementById("duration");
      const umurEl = document.getElementById("age");

      const durasi = durasiEl && durasiEl.value ? durasiEl.value : null;
      const umur = umurEl && umurEl.value ? umurEl.value : null;

      const isMentalSectionVisible = !mentalSection.classList.contains('hidden-section');
      const isHabitSectionVisible = !habitSection.classList.contains('hidden-section');
      const isImpactSectionVisible = !impactSection.classList.contains('hidden-section');
      const isDurationSectionVisible = !durationSection.classList.contains('hidden-section');

      // Validasi agar semua bagian terisi sebelum analisa
      if (!umur || umur === "" ||
        fisikCheckboxes.length === 0 ||
        (isMentalSectionVisible && selectedMentalValues.length === 0) ||
        (isHabitSectionVisible && selectedHabitValues.length === 0) ||
        (isImpactSectionVisible && selectedImpactValues.length === 0) ||
        (isDurationSectionVisible && (!durasi || durasi === ""))) {
        return { error: "Harap isi semua data dan keluhan Anda terlebih dahulu." };
      }

      // Kumpulkan detail gejala yang dipilih untuk ditampilkan dan dikirim
      selectedSymptomsDetails.fisik = fisikCheckboxes.map(cb => cb.value).join(", ");
      selectedSymptomsDetails.mental = mentalCheckboxes.map(cb => cb.value).join(", ");
      selectedSymptomsDetails.habit = habitCheckboxes.map(cb => cb.value).join(", ");
      selectedSymptomsDetails.impact = impactCheckboxes.map(cb => cb.value).join(", ");

      const fisikSkor = fisikCheckboxes.length;
      const mentalSkor = mentalCheckboxes.length;
      const habitSkor = habitCheckboxes.length;
      const impactSkor = impactCheckboxes.length;

      let durasiSkor = 0;
      if (durasi === "<<1 minggu") durasiSkor = 1;
      else if (durasi === "1-3 minggu" || durasi === "1-3 bulan") durasiSkor = 2;
      else if (
        durasi === ">> 3 bulan" ||
        durasi === "1 tahun" ||
        durasi === "2 tahun" ||
        durasi === "3 tahun" ||
        durasi === "Lebih dari 3 tahun"
      ) {
        durasiSkor = 3;
      }

      const totalSkor = fisikSkor + mentalSkor + habitSkor + impactSkor + durasiSkor;

      let diagnosis = "", deskripsi = "", tingkat = "", rekomendasiProductId = null;

      if (totalSkor <= 7) {
        tingkat = "Ringan";
        diagnosis = "Dispepsia Fungsional";
        deskripsi = `
          Anda mungkin mengalami <strong>Dispepsia Fungsional</strong>, yaitu gangguan pencernaan bagian atas tanpa kerusakan fisik, fokus pada <strong>fungsi kerja lambung</strong> yang terganggu. Gejala umum: <strong>perut penuh/kembung, nyeri ulu hati</strong>. Sering dipicu <strong>stres</strong>. Dengan penanganan tepat, kualitas hidup Anda bisa kembali optimal!
        `;
        rekomendasiProductId = "Nutrient Super Calcium Powder";

      } else if (totalSkor <= 15) {
        tingkat = "Sedang";
        diagnosis = "GERD (Gastroesophageal Reflux Disease)";
        deskripsi = `
          Kemungkinan Anda mengalami <strong>GERD (Gastroesophageal Reflux Disease)</strong>, di mana <strong>asam lambung sering naik ke kerongkongan</strong> karena <strong>katup LES melemah</strong>. Gejala khas: <strong>panas di dada (heartburn), asam di tenggorokan, batuk/serak</strong>. Kondisi ini bisa diatasi agar Anda bebas beraktivitas tanpa khawatir!
        `;
        const hasImpactSymptoms = impactCheckboxes.some(cb => cb.value === "Kehilangan nafsu makan" || cb.value === "Berat badan turun drastis");
        const hasBurningSymptoms = fisikCheckboxes.some(cb => cb.value === "Dada terasa panas (heartburn)" || fisikCheckboxes.some(cb => cb.value === "Asam naik ke tenggorokan"));

        if (hasImpactSymptoms || durasiSkor >= 2) {
          rekomendasiProductId = "Zinc Capsules";
        } else if (hasBurningSymptoms || fisikCheckboxes.some(cb => cb.value === "Perut kembung")) {
          rekomendasiProductId = "Nutrient Super Calcium Powder";
        } else {
          rekomendasiProductId = "Nutrient Super Calcium Powder";
        }

      } else { // totalSkor > 15 (Berat)
        tingkat = "Berat";
        diagnosis = "GERD Kronis & Psikosomatis";
        deskripsi = `
          Anda berpotensi mengalami <strong>GERD Kronis & Psikosomatis</strong>, GERD yang sudah <strong>berlangsung lama</strong> dan sangat dipengaruhi oleh <strong>stres, cemas, atau serangan panik</strong>. Pikiran dan fisik saling memengaruhi. Gejala bisa sangat intens. Pahami kondisi ini untuk meraih kembali ketenangan dan kesehatan optimal!
        `;
        const hasBadHabits = habitCheckboxes.some(cb => cb.value === "Sering makan pedas/berminyak" || cb.value === "Sering konsumsi obat kimia");
        const hasImpactSymptoms = impactCheckboxes.some(cb => cb.value === "Kehilangan nafsu makan" || cb.value === "Berat badan turun drastis");
        const hasBurningSymptoms = fisikCheckboxes.some(cb => cb.value === "Dada terasa panas (heartburn)" || fisikCheckboxes.some(cb => cb.value === "Asam naik ke tenggorokan"));

        if (hasBadHabits || durasiSkor === 3) {
          rekomendasiProductId = "Chitin Chitosan Capsules";
        } else if (hasImpactSymptoms) {
          rekomendasiProductId = "Zinc Capsules";
        } else if (hasBurningSymptoms || fisikCheckboxes.some(cb => cb.value === "Perut kembung")) {
          rekomendasiProductId = "Nutrient Super Calcium Powder";
        } else {
          rekomendasiProductId = "Zinc Capsules";
        }
      }

      return {
        umur,
        durasi,
        fisik: fisikSkor, // tetap simpan skornya juga
        mental: mentalSkor,
        habit: habitSkor,
        impact: impactSkor,
        tingkat,
        diagnosis,
        deskripsi,
        rekomendasiProductId
      };
    }

    document.getElementById("cekButton").addEventListener("click", function () {
      const hasil = calculateSeverity();
      const hasilBox = document.getElementById("hasilPenilaian");

      if (hasil.error) {
        hasilBox.innerHTML = `<h2 style="color: red;">${hasil.error}</h2>`;
        hasilBox.style.display = "block";
        displayTiensProducts(); // Pastikan produk tetap tampil meski ada error
        return;
      }

      let output = `<h2>üìã Hasil Analisa </h2>`;

      if (hasil.umur) {
        output += `<p><strong>Usia:</strong> ${hasil.umur} tahun</p>`;
      }

      if (hasil.durasi) {
        output += `<p><strong>Durasi Gejala:</strong> ${hasil.durasi}</p>`;
      }

      // Tampilkan detail gejala
      if (selectedSymptomsDetails.fisik) {
        output += `<p><strong>Gejala Fisik:</strong> ${selectedSymptomsDetails.fisik}</p>`;
      } else {
        output += `<p><strong>Gejala Fisik:</strong> Tidak ada yang dipilih</p>`;
      }

      if (selectedSymptomsDetails.mental) {
        output += `<p><strong>Psikologis:</strong> ${selectedSymptomsDetails.mental}</p>`;
      } else {
        output += `<p><strong>Psikologis:</strong> Tidak ada yang dipilih</p>`;
      }

      if (selectedSymptomsDetails.habit) {
        output += `<p><strong>Kebiasaan Buruk:</strong> ${selectedSymptomsDetails.habit}</p>`;
      } else {
        output += `<p><strong>Kebiasaan Buruk:</strong> Tidak ada yang dipilih</p>`;
      }

      if (selectedSymptomsDetails.impact) {
        output += `<p><strong>Dampak Kehidupan:</strong> ${selectedSymptomsDetails.impact}</p>`;
      } else {
        output += `<p><strong>Dampak Kehidupan:</strong> Tidak ada yang dipilih</p>`;
      }

      output += `
        <hr>
        <p><strong>Tingkat Keparahan:</strong> <span id="tingkatKeparahanText">${hasil.tingkat}</span></p>
        <h3>ü©∫ Diagnosis: ${hasil.diagnosis}</h3>
        <p>${hasil.deskripsi}</p>
      `;

      if (hasil.rekomendasiProductId) {
        const recommendedProduct = tiensProducts.find(p => p.id === hasil.rekomendasiProductId);
        if (recommendedProduct) {
          output += `<h3>üåø Rekomendasi Produk Tiens (Paling Relevan):</h3>`;
          output += `<p>${recommendedProduct.name}</p>`;
        }
      }

      hasilBox.innerHTML = output;
      hasilBox.style.display = "block";

      // Setelah hasil ditampilkan, atur warna teks tingkat keparahan
      const tingkatKeparahanTextElement = document.getElementById("tingkatKeparahanText");
      if (tingkatKeparahanTextElement) {
        let warna = "";
        if (hasil.tingkat === "Berat") {
          warna = "red";
        } else if (hasil.tingkat === "Sedang") {
          warna = "#FFA500"; 
        } else if (hasil.tingkat === "Ringan") {
          warna = "green";
        }
        tingkatKeparahanTextElement.style.color = warna;
        tingkatKeparahanTextElement.style.fontWeight = "bold"; // Opsional: agar lebih menonjol
      }

      // --- Ambil teks hasil analisa setelah ditampilkan dan format untuk WhatsApp ---
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = output; // Masukkan HTML ke div sementara

      // Hapus tag HTML, karakter non-breaking space (&nbsp;), dan trim
      let rawText = tempDiv.innerText.replace(/[\u00A0\u200B-\u200D\uFEFF]/g, ' ').trim();

      // Format ulang untuk kerapihan di WhatsApp
      rawText = rawText.replace(/üìã Hasil Analisa Keparahan/g, "Hasil Analisa Kondisi Saya");
      rawText = rawText.replace(/Usia:/g, "\nUsia:");
      rawText = rawText.replace(/Durasi Gejala:/g, "\nDurasi Gejala:");
      rawText = rawText.replace(/Gejala Fisik:/g, "\nGejala Fisik:");
      rawText = rawText.replace(/Psikologis:/g, "\nPsikologis:");
      rawText = rawText.replace(/Kebiasaan Buruk:/g, "\nKebiasaan Buruk:");
      rawText = rawText.replace(/Dampak Kehidupan:/g, "\nDampak Kehidupan:");
      rawText = rawText.replace(/Tingkat Keparahan:/g, "\nTingkat Keparahan:");
      rawText = rawText.replace(/ü©∫ Diagnosis:/g, "\nDiagnosis:");
      rawText = rawText.replace(/üåø Rekomendasi Produk Tiens \(Paling Relevan\):/g, "\nüì¶ Rekomendasi Produk:");
      rawText = rawText.replace(/\n\s*\n\s*\n/g, "\n\n"); // Mengurangi baris kosong berlebihan
      rawText = rawText.replace(/Tidak ada yang dipilih/g, "Tidak ada"); // Konsistenkan pesan "Tidak ada yang dipilih"
      rawText = rawText.replace(/:\s*,/g, ": -"); // Jika ada ": ," ubah jadi ": -" (jika tidak ada pilihan)

      currentAnalysisResultText = rawText;

      displayTiensProducts(hasil.rekomendasiProductId);
    });

    // Inisialisasi: Sembunyikan semua bagian di awal saat DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      if (mentalSection && habitSection && impactSection && durationSection) {
        mentalSection.classList.add('hidden-section');
        habitSection.classList.add('hidden-section');
        impactSection.classList.add('hidden-section');
        durationSection.classList.add('hidden-section');
      } else {
        console.error("Inisialisasi: Salah satu elemen section form tidak ditemukan.");
      }
      displayTiensProducts(); // Tampilkan produk di awal
      checkFormProgress(); // Jalankan check progress untuk inisialisasi visibilitas
    });
  </script>
</body>
</html>